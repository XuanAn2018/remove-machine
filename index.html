<!-- START OF FILE deepseek_mes_scanner_final_fix.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ MES IoT Scanner Pro (Fixed)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* GIỮ NGUYÊN STYLE CŨ VÌ GIAO DIỆN ĐÃ TỐT */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding: 25px; background: rgba(30, 41, 59, 0.8); border-radius: 15px; border: 1px solid #3b82f6; }
        .header h1 { font-size: 28px; margin-bottom: 10px; color: #60a5fa; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .main-panel { background: rgba(30, 41, 59, 0.6); border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(59, 130, 246, 0.3); }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .config-card { background: rgba(15, 23, 42, 0.8); padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .config-card h3 { color: #60a5fa; margin-bottom: 15px; font-size: 16px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #cbd5e1; font-size: 13px; }
        .form-control { width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #475569; border-radius: 6px; color: #fff; font-size: 13px; }
        .package-details-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-top: 15px; display: none; }
        .package-id-display { font-size: 13px; color: #10b981; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed rgba(16, 185, 129, 0.3); padding-bottom: 8px; word-break: break-all; }
        .package-meta-display { font-size: 13px; color: #e2e8f0; display: flex; flex-wrap: wrap; gap: 8px; }
        .meta-tag { background: rgba(15, 23, 42, 0.6); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        .meta-highlight { color: #facc15; font-weight: bold; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-primary { background: #2563eb; }
        .btn-danger { background: #dc2626; }
        .btn-warning { background: #d97706; }
        .btn-secondary { background: #475569; }
        .btn-stop { background: #7c3aed; }
        .btn-fa { background: #db2777; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin: 25px 0; }
        .machine-list-container { max-height: 550px; overflow-y: auto; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(15, 23, 42, 0.8); margin-top: 20px; }
        .machine-item { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: flex-start; gap: 15px; }
        .machine-item:last-child { border-bottom: none; }
        .machine-item.selected { background: rgba(245, 158, 11, 0.15); border-left: 3px solid #f59e0b; }
        .machine-checkbox { width: 18px; height: 18px; margin-top: 4px; cursor: pointer; accent-color: #f59e0b; }
        .machine-info { flex: 1; }
        .machine-row-1 { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
        .machine-title { color: #e2e8f0; font-weight: 700; font-size: 14px; }
        .machine-module { color: #94a3b8; font-size: 13px; }
        .machine-remarks { color: #facc15; font-size: 13px; font-style: italic; }
        .machine-row-2 { margin-bottom: 6px; font-size: 13px; color: #cbd5e1; }
        .mcid-tag { color: #60a5fa; font-weight: bold; background: rgba(59, 130, 246, 0.1); padding: 2px 6px; border-radius: 4px; }
        .machine-iot-row { background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(45, 212, 191, 0.2); border-radius: 6px; padding: 8px; margin-top: 5px; font-size: 12px; display: flex; flex-direction: column; gap: 3px; }
        .iot-value { color: #2dd4bf; font-weight: bold; }
        .iot-time-label { color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .iot-time-value { color: #e2e8f0; font-family: 'Consolas', monospace; }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 11px; }
        .log-console { background: #0f172a; border-radius: 8px; padding: 15px; margin-top: 20px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid #334155; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-time { color: #64748b; min-width: 60px; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .iot-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #64748b; color: white; }
        .iot-fa { background: #10b981; }
        .iot-qa { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-satellite-dish"></i> MES IoT Scanner Pro</h1>
            <p>Quét chi tiết máy, dữ liệu IoT và quản lý</p>
        </div>
        
        <!-- MAIN -->
        <div class="main-panel">
            <div class="config-grid">
                <!-- API CONFIG -->
                <div class="config-card">
                    <h3><i class="fas fa-key"></i> Cấu Hình</h3>
                    <div class="form-group">
                        <label>API Key:</label>
                        <input type="password" id="apiKey" class="form-control" placeholder="Nhập API Key quản trị...">
                    </div>
                    <div class="form-group">
                        <label>Nhà máy:</label>
                        <select id="factory" class="form-control">
                            <option value="P2C1">P2C1</option>
                            <option value="P2A1">P2A1</option>
                            <option value="P2B1">P2B1</option>
                        </select>
                    </div>
                </div>
                
                <!-- PACKAGE SELECT -->
                <div class="config-card">
                    <h3><i class="fas fa-box"></i> Chọn Package</h3>
                    <div class="form-group">
                        <div style="display: flex; gap: 8px;">
                            <select id="packageSelect" class="form-control">
                                <option value="">-- Chọn Package --</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadTodayPackages()" id="loadPackagesBtn"><i class="fas fa-sync"></i></button>
                        </div>
                        <input type="text" id="mxpackage" class="form-control" placeholder="Hoặc nhập Package ID..." style="margin-top: 10px;">
                    </div>
                    
                    <div id="packageInfoBox" class="package-details-box">
                        <div class="package-id-display" id="pkgIdDisplay"></div>
                        <div class="package-meta-display" id="pkgMetaDisplay"></div>
                    </div>
                </div>
            </div>
            
            <!-- ACTIONS -->
            <div class="action-grid">
                <button class="btn btn-primary" onclick="startFullScanProcess()" id="scanBtn"><i class="fas fa-search"></i> Quét Chi Tiết</button>
                <button class="btn btn-stop" onclick="stopScanProcess()" id="stopBtn" style="display: none;"><i class="fas fa-stop"></i> Dừng</button>
                <button class="btn btn-warning" onclick="handleSelection(true)" id="selectAllBtn" disabled><i class="fas fa-check-double"></i> Chọn Hết</button>
                <button class="btn btn-warning" onclick="handleSelection(false)" id="deselectAllBtn" disabled><i class="fas fa-times"></i> Bỏ Chọn</button>
                <button class="btn btn-fa" onclick="confirmSendFa()" id="sendFaBtn" disabled><i class="fas fa-paper-plane"></i> Gửi FA</button>
                <button class="btn btn-danger" onclick="confirmRemoveMachines()" id="removeBtn" disabled><i class="fas fa-trash"></i> Xóa Máy</button>
            </div>
            
            <!-- PROGRESS -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
            
            <!-- STATS -->
            <div style="text-align: right; margin-bottom: 10px; font-size: 12px; color: #94a3b8;">
                Máy tìm thấy: <strong style="color:#10b981" id="statFound">0</strong> | 
                Đã chọn: <strong style="color:#facc15" id="statSelected">0</strong>
            </div>
            
            <!-- LIST -->
            <div class="machine-list-container" id="machineListContainer">
                <div style="padding: 40px; text-align: center; color: #64748b;">
                    <i class="fas fa-search-location" style="font-size: 40px; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Nhấn "Quét Chi Tiết" để hiển thị dữ liệu IoT</p>
                </div>
            </div>
            
            <!-- LOGS -->
            <div class="log-console" id="logConsole">
                <div class="log-entry"><span class="log-time">[SYSTEM]</span><span class="log-info">Ready to scan...</span></div>
            </div>
        </div>
    </div>

    <script>
        const PACKAGE_API = "https://today-package.chiscoong-cloudflare-com.workers.dev/";
        const MODULE_OPS_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/opdetails";
        const MODULE_DETAIL_API = "https://module-requests.chiscoong-cloudflare-com.workers.dev/detail";
        const REMOVE_API = "https://remove-machine.chiscoong-cloudflare-com.workers.dev/";
        const SCANNER_API = "https://mes-qr-scanner.chiscoong-cloudflare-com.workers.dev/";
        
        let discoveredMachines = [];
        let isProcessing = false;
        let abortController = null;
        
        function log(msg, type = 'info') {
            const el = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString('vi-VN', {hour12: false});
            el.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span></div>`;
            el.scrollTop = el.scrollHeight;
        }

        function formatDateTime(isoString) {
            if (!isoString) return "N/A";
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return isoString;
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = date.getFullYear();
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                const ss = String(date.getSeconds()).padStart(2, '0');
                return `${d}/${m}/${y} - ${hh}:${mm}:${ss}`;
            } catch (e) { return "Invalid Date"; }
        }

        // ============ KHU VỰC SỬA LỖI LOGIC ============
        function parseMxPackage(mxpackage) {
            try {
                // 1. Tìm chuỗi con chứa StyleInfo. 
                // Tìm đoạn text có ít nhất 2 chữ, kết thúc bằng 6 số (Color3 + Rev3)
                // Regex tìm: (Mọi thứ) + (6 số cuối) + (Kết thúc chuỗi hoặc _)
                const match = mxpackage.match(/([A-Z0-9]+)(\d{6})(?=_|$)/);
                
                if (!match) return { success: false };
                
                // match[0] là toàn bộ chuỗi khớp: HAR0287RGL001001
                const fullStr = match[0];
                const len = fullStr.length;
                
                // Cắt từ phải sang trái (Chắc chắn đúng vì 6 số cuối luôn cố định)
                const revno = fullStr.substring(len - 3);        // 001
                const color = fullStr.substring(len - 6, len - 3); // 001
                
                // Phần còn lại là StyleCode + Size: HAR0287RGL
                const leftPart = fullStr.substring(0, len - 6);
                
                // Tách Style và Size từ phần còn lại
                // Size thường là 2 hoặc 3 chữ cái in hoa ở cuối (RGL, XL, S, M...)
                // Logic: Kiểm tra 3 ký tự cuối
                const last3 = leftPart.slice(-3);
                const last2 = leftPart.slice(-2);
                
                let stylecode = "";
                let stylesize = "";
                
                // Nếu 3 ký tự cuối đều là chữ -> Size 3 ký tự (VD: RGL)
                if (/^[A-Z]+$/.test(last3)) {
                    stylesize = last3;
                    stylecode = leftPart.slice(0, -3);
                } 
                // Ngược lại lấy 2 ký tự (VD: XL, GL)
                else {
                    stylesize = last2;
                    stylecode = leftPart.slice(0, -2);
                }

                return {
                    stylecode: stylecode,
                    stylesize: stylesize,
                    stylecolorserial: color,
                    revno: revno,
                    success: true
                };
            } catch (e) {
                console.error(e);
                return { success: false };
            }
        }
        // ===============================================

        async function startFullScanProcess() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const pkgId = document.getElementById('mxpackage').value.trim();
            
            if(!apiKey || !pkgId) { alert("Thiếu API Key hoặc Package ID!"); return; }
            
            isProcessing = true;
            abortController = new AbortController();
            discoveredMachines = [];
            toggleButtons(true);
            document.getElementById('machineListContainer').innerHTML = '';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('statFound').innerText = '0';
            
            log(`Bắt đầu quét gói: ${pkgId}`, 'info');
            
            try {
                // Parse Style Info
                const styleInfo = parseMxPackage(pkgId);
                if(!styleInfo.success) throw new Error("Không thể phân tích Package ID. Định dạng không hỗ trợ.");
                
                log(`Parsed: Style ${styleInfo.stylecode} | Size ${styleInfo.stylesize} | Color ${styleInfo.stylecolorserial} | Rev ${styleInfo.revno}`, 'success');

                // Get Operations
                const opsUrl = `${MODULE_OPS_API}?mxpackage=${encodeURIComponent(pkgId)}&mode=operations&apikey=${apiKey}`;
                const opsRes = await fetch(opsUrl, { signal: abortController.signal });
                const opsData = await opsRes.json();
                
                if(!opsData.success || !opsData.data?.operations) throw new Error("Lỗi lấy danh sách công đoạn.");
                
                const operations = opsData.data.operations;
                log(`Tìm thấy ${operations.length} công đoạn.`, 'info');
                
                // Scan Loop
                for(let i=0; i<operations.length; i++) {
                    const op = operations[i];
                    updateProgress((i/operations.length)*100, `Quét OP: ${op.opserial}`);
                    
                    try {
                        const detailUrl = `${MODULE_DETAIL_API}?stylecode=${styleInfo.stylecode}&stylesize=${styleInfo.stylesize}&stylecolorserial=${styleInfo.stylecolorserial}&revno=${styleInfo.revno}&oprevno=${op.oprevno}&opserial=${op.opserial}&apikey=${apiKey}`;
                        const detailRes = await fetch(detailUrl, { signal: abortController.signal });
                        const detailJson = await detailRes.json();
                        
                        if(detailJson.success && detailJson.data?.Result?.MachineList) {
                            detailJson.data.Result.MachineList.forEach(m => {
                                if(m.MCID && m.MCID !== 'N/A') {
                                    discoveredMachines.push({
                                        pkg: pkgId,
                                        mcid: m.MCID,
                                        opserial: op.opserial,
                                        opname: op.opname || 'Unknown',
                                        module: op.modulename || op.MODULENAME || 'N/A',
                                        remarks: op.remarks || op.REMARKS || '', 
                                        iotType: (op.iottype || 'NONE').toUpperCase(),
                                        lastIotData: m.LAST_IOT_DATA,
                                        lastIotTime: m.LAST_IOT_DATA_RECEIVE_TIME,
                                        selected: false
                                    });
                                }
                            });
                        }
                    } catch (err) {}
                    await new Promise(r => setTimeout(r, 100)); // Delay nhỏ hơn chút
                }
                
                renderMachines();
                log(`Hoàn tất. Tìm thấy ${discoveredMachines.length} máy.`, 'success');
                
            } catch (e) {
                if(e.name === 'AbortError') log("Đã dừng quét.", 'warning');
                else log(`Lỗi: ${e.message}`, 'error');
            } finally {
                isProcessing = false;
                toggleButtons(false);
                updateProgress(100, "Hoàn tất");
            }
        }

        function renderMachines() {
            const container = document.getElementById('machineListContainer');
            document.getElementById('statFound').innerText = discoveredMachines.length;
            
            if(discoveredMachines.length === 0) {
                container.innerHTML = `<div style="padding:30px;text-align:center;color:#ef4444">Không tìm thấy máy nào. Vui lòng kiểm tra lại Package ID.</div>`;
                return;
            }
            
            let html = '';
            discoveredMachines.forEach((m, idx) => {
                const badgeClass = m.iotType === 'FA' ? 'iot-fa' : (m.iotType === 'QA' ? 'iot-qa' : 'iot-none');
                const iotDataDisplay = (m.lastIotData !== null && m.lastIotData !== undefined) ? m.lastIotData : 'N/A';
                const iotTimeDisplay = formatDateTime(m.lastIotTime);
                const remarksPart = m.remarks ? ` | <span class="machine-remarks">${m.remarks}</span>` : '';
                
                html += `
                    <div class="machine-item" id="machine-${idx}">
                        <input type="checkbox" class="machine-checkbox" onchange="toggleMachine(${idx})">
                        <div class="machine-info">
                            <div class="machine-row-1">
                                <span class="machine-title">${m.opname}</span>
                                <span style="color:#64748b">|</span>
                                <span class="machine-module">${m.module}</span>
                                ${remarksPart}
                            </div>
                            <div class="machine-row-2">
                                <span class="mcid-tag">${m.mcid}</span>
                                <span style="margin: 0 5px;">•</span>
                                <span>OP: <strong>${m.opserial}</strong></span>
                                <span style="margin-left: 10px;" class="iot-badge ${badgeClass}">${m.iotType}</span>
                            </div>
                            <div class="machine-iot-row">
                                <div><span class="iot-time-label">IoT Data:</span> <span class="iot-value">${iotDataDisplay}</span></div>
                                <div><span class="iot-time-label">THỜI GIAN NHẬN DỮ LIỆU IoT CUỐI CÙNG:</span> <span class="iot-time-value">${iotTimeDisplay}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleSelection(isSelect) {
            discoveredMachines.forEach(m => m.selected = isSelect);
            document.querySelectorAll('.machine-checkbox').forEach(cb => cb.checked = isSelect);
            document.querySelectorAll('.machine-item').forEach(el => isSelect ? el.classList.add('selected') : el.classList.remove('selected'));
            updateStats();
        }
        
        function toggleMachine(idx) {
            discoveredMachines[idx].selected = !discoveredMachines[idx].selected;
            const el = document.getElementById(`machine-${idx}`);
            discoveredMachines[idx].selected ? el.classList.add('selected') : el.classList.remove('selected');
            updateStats();
        }
        
        function updateStats() {
            const count = discoveredMachines.filter(m => m.selected).length;
            document.getElementById('statSelected').innerText = count;
            document.getElementById('removeBtn').disabled = count === 0;
            document.getElementById('sendFaBtn').disabled = count === 0;
        }

        function updateProgress(pct, text) {
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${Math.round(pct)}% - ${text}`;
        }
        
        function stopScanProcess() { if(abortController) abortController.abort(); isProcessing = false; }

        function toggleButtons(disabled) {
            document.getElementById('scanBtn').style.display = disabled ? 'none' : 'inline-flex';
            document.getElementById('stopBtn').style.display = disabled ? 'inline-flex' : 'none';
            ['selectAllBtn', 'deselectAllBtn', 'removeBtn', 'sendFaBtn', 'loadPackagesBtn'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = disabled;
            });
        }

        async function confirmSendFa() {
            const selected = discoveredMachines.filter(m => m.selected);
            if(confirm(`Gửi lệnh FA đến ${selected.length} máy đã chọn?`)) processBatch(selected, 'FA');
        }

        async function confirmRemoveMachines() {
            const selected = discoveredMachines.filter(m => m.selected);
            if(confirm(`CẢNH BÁO: Xóa ${selected.length} máy khỏi Package?`)) processBatch(selected, 'REMOVE');
        }

        async function processBatch(items, action) {
            const apiKey = document.getElementById('apiKey').value.trim();
            isProcessing = true;
            toggleButtons(true);
            document.getElementById('progressContainer').style.display = 'block';
            let success = 0, fail = 0;
            
            for(let i=0; i<items.length; i++) {
                const item = items[i];
                updateProgress((i/items.length)*100, `${action}: ${item.mcid}`);
                try {
                    let url = action === 'FA' 
                        ? `${SCANNER_API}?apikey=${apiKey}&mxpackage=${encodeURIComponent(item.pkg)}&mcid=${encodeURIComponent(item.mcid)}&opserial=${item.opserial}&processtype=FA`
                        : `${REMOVE_API}?apikey=${apiKey}&mxpackage=${encodeURIComponent(item.pkg)}&mcid=${encodeURIComponent(item.mcid)}&opserial=${item.opserial}`;
                    
                    const res = await fetch(url);
                    const json = await res.json();
                    
                    if(json.IsSuccess) {
                        success++;
                        log(`✅ ${action} OK: ${item.mcid}`, 'success');
                        const row = document.getElementById(`machine-${discoveredMachines.indexOf(item)}`);
                        if(action === 'REMOVE') {
                            row.style.opacity = '0.4'; row.style.textDecoration = 'line-through';
                            row.querySelector('input').disabled = true; item.selected = false;
                        } else {
                            row.style.background = 'rgba(16, 185, 129, 0.1)';
                        }
                    } else throw new Error(json.Log || 'Fail');
                } catch(e) {
                    fail++;
                    log(`❌ Lỗi ${item.mcid}: ${e.message}`, 'error');
                }
                await new Promise(r => setTimeout(r, 1000));
            }
            isProcessing = false;
            toggleButtons(false);
            updateProgress(100, `Hoàn tất: ${success} OK, ${fail} Lỗi`);
            updateStats();
        }

        async function loadTodayPackages() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const factory = document.getElementById('factory').value;
            const select = document.getElementById('packageSelect');
            if(!apiKey) { alert("Nhập API Key trước!"); return; }
            select.innerHTML = '<option>Loading...</option>';
            try {
                const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
                const res = await fetch(`${PACKAGE_API}?factory=${factory}&fromDate=${dateStr}`, { headers: {'X-API-Key': apiKey} });
                const data = await res.json();
                select.innerHTML = '<option value="">-- Chọn Package --</option>';
                const pkgs = data.success ? (data.data.packages || data.data) : [];
                pkgs.forEach(p => {
                    const id = p.packageId || p.MXPACKAGE;
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = `${p.lineName || p.LINENAME} | ${p.styleText || p.STYLETEXT}`;
                    opt.dataset.details = JSON.stringify({
                        line: p.lineName || p.LINENAME,
                        style: p.styleText || p.STYLETEXT,
                        target: p.target || p.TARGET,
                        factory: factory
                    });
                    select.add(opt);
                });
            } catch(e) {
                select.innerHTML = '<option>Lỗi tải data</option>';
            }
        }
        
        document.getElementById('packageSelect').addEventListener('change', function() {
            if(this.value) {
                document.getElementById('mxpackage').value = this.value;
                const data = JSON.parse(this.options[this.selectedIndex].dataset.details);
                document.getElementById('packageInfoBox').style.display = 'block';
                document.getElementById('pkgIdDisplay').innerText = this.value;
                document.getElementById('pkgMetaDisplay').innerHTML = `
                    <span class="meta-tag">${data.factory}</span>
                    <span class="meta-tag">${data.line}</span>
                    <span class="meta-tag meta-highlight">${data.style}</span>
                    <span class="meta-tag">Target: ${data.target}</span>
                `;
            }
        });

        document.getElementById('factory').value = 'P2C1';
    </script>
</body>
</html>
